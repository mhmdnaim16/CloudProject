trigger:
- master

variables:
  azureSubscription: '72b20364-fb47-4462-ba78-c258e770533b'
  webAppName: 'mhmdnaimwebapp'
  environmentName: 'mhmdnaimwebapp'
  rootFolder: '$(System.DefaultWorkingDirectory)'

stages:

# ===================================================================
# BUILD STAGE  (RUNNING ON YOUR SELF-HOSTED VM AGENT)
# ===================================================================
- stage: Build
  displayName: "Build Laravel App"

  jobs:
  - job: BuildJob
    displayName: "BuildJob"

    pool:
      name: CloudProjectPool   # <-- YOUR SELF-HOSTED AGENT POOL NAME

    steps:

    # 1) Show PHP version
    - script: php -v
      displayName: "Show PHP Version"

    # 2) Install Composer dependencies
    - script: |
        composer install --no-interaction --prefer-dist --optimize-autoloader
      workingDirectory: $(rootFolder)
      displayName: "Composer Install"

    # 3) Laravel optimize (no .env needed)
    - script: |
        php artisan config:cache || true
        php artisan route:cache || true
        php artisan view:cache || true
      workingDirectory: $(rootFolder)
      displayName: "Optimize Laravel"

    # 4) Archive build folder
    - task: ArchiveFiles@2
      displayName: "Archive App Files"
      inputs:
        rootFolderOrFile: '$(rootFolder)'
        includeRootFolder: false
        archiveType: zip
        archiveFile: $(Build.ArtifactStagingDirectory)/build.zip
        replaceExistingArchive: true

    # 5) Publish artifact
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/build.zip'
        ArtifactName: 'drop'
        publishLocation: 'Container'


# ===================================================================
# DEPLOY STAGE
# ===================================================================
- stage: Deploy
  displayName: "Deploy to Azure Web App"
  dependsOn: Build
  condition: succeeded()

  jobs:
  - deployment: DeploymentJob
    displayName: "Deploy Laravel App"
    environment: $(environmentName)
    
    pool:
      name: CloudProjectPool     # SAME SELF-HOSTED POOL

    strategy:
      runOnce:
        deploy:
          steps:

          - task: AzureWebApp@1
            displayName: "Deploy to mhmdnaimwebapp"
            inputs:
              azureSubscription: $(azureSubscription)
              appName: $(webAppName)
              appType: webAppLinux
              package: $(Pipeline.Workspace)/drop/build.zip
