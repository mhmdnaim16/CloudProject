stages:
# ===========================
# BUILD STAGE
# ===========================
- stage: Build
  displayName: "Build Laravel App"
  jobs:
  - job: BuildJob
    displayName: "BuildJob"
    pool:
      name: CloudProjectPool   # <-- your self-hosted agent pool

    steps:
    - checkout: self

    # 1) Show PHP version (optional, for debug)
    - script: php -v
      displayName: "Show PHP Version"

    # 2) Install Composer dependencies
    - script: composer install --no-interaction --prefer-dist --optimize-autoloader
      displayName: "Composer Install"

    # 3) Prepare Laravel (.env + APP_KEY + caches)
    - script: |
        cp .env.example .env
        php artisan key:generate
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
      displayName: "Optimize Laravel"

    # 4) Archive app for deployment
    - task: ArchiveFiles@2
      displayName: "Archive App Files"
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
        archiveType: zip
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        replaceExistingArchive: true

    # 5) Publish artifact
    - task: PublishBuildArtifacts@1
      displayName: "PublishBuildArtifacts"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

# ===========================
# DEPLOY STAGE
# ===========================
- stage: Deploy
  displayName: "Deploy to Azure Web App"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployLaravelApp
    displayName: "Deploy Laravel App"
    pool:
      name: CloudProjectPool   # same pool

    steps:
    - download: current
      artifact: drop
      displayName: "Download Artifact"

    - task: AzureWebApp@1
      displayName: "Deploy to mhmdnaimwebapp"
      inputs:
        azureSubscription: '72b20364-fb47-4462-ba78-c258e770533b'  # your service connection
        appName: 'mhmdnaimwebapp'
        appType: 'webAppLinux'
        package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
